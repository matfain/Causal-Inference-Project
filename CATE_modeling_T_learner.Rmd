---
title: "CATE_modeling"
author: "Matan & Hillel & Yael"
date: "2025-07-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ranger)
library(xgboost)
library(doParallel)
library(foreach)
library(knitr)

source("utils/data_pipelines_utils.R")
source("utils/plot_utils.R")
source("utils/cate_utils_final.R")
```

```{r}
base_df <- read_csv("data/full_cohort_data.csv", show_col_types = FALSE)

treatment <- "aline_flg"
outcome   <- "day_28_flg"

# --- replicate the same cleaning/positivity tweaks ---
individual_properties <- c("age","gender_num","weight_first","bmi")
severity_scores       <- c("sapsi_first","sofa_first")
vital_signs           <- c("map_1st","hr_1st","temp_1st","spo2_1st")
lab_results           <- c("wbc_first","hgb_first","platelet_first","sodium_first",
                           "potassium_first","tco2_first","chloride_first",
                           "bun_first", "creatinine_first","po2_first","pco2_first")

first_day     <- "iv_day_1"
comorbidities <- c("chf_flg","afib_flg","renal_flg","liver_flg","copd_flg",
                   "cad_flg","stroke_flg","mal_flg","resp_flg")
admission_properties <- c("service_unit","day_icu_intime","hour_icu_intime")

confounders <- c(individual_properties, severity_scores, vital_signs,
                 lab_results, first_day, comorbidities, admission_properties)

# drop BMI
clean_df <- base_df %>% select(-bmi)
confounders <- setdiff(confounders, "bmi")

# bin SOFA
final_base_df <- clean_df %>%
  mutate(sofa_first_cat = case_when(
    sofa_first < 2.5 ~ "0-2.5",
    sofa_first < 5   ~ "2.5-5",
    sofa_first < 7.5 ~ "5-7.5",
    sofa_first < 10  ~ "7.5-10",
    TRUE             ~ "10+")) %>%
  select(-sofa_first)

confounders <- setdiff(confounders, "sofa_first") %>% append("sofa_first_cat")

# median imputation
df_median <- final_base_df %>%
  select(all_of(c(treatment, outcome, confounders))) %>%
  impute_df(method = "median")
```

#### Definitions for base learners and effect modifiers

```{r}
## Choose effect modifiers (can overlap with confounders)
effect_modifiers <- c("age", "gender_num", "weight_first",
                      "service_unit", "liver_flg")

## Re-cast binary-numeric modifiers to factors  (affects df_median only)
for (mod in effect_modifiers) {
  x <- df_median[[mod]]
  if (is.numeric(x) && setequal(na.omit(unique(x)), c(0, 1))) {
    df_median[[mod]] <- factor(x, levels = c(0, 1))
  }
}


## Choose base learners
base_learners <- c("rf", "xgb")
```

#### Fit T learner and compute CATE

```{r}
results_list <- list()

for (learner in base_learners) {
  message("=== Fitting T-learner with ", learner, " ===")
  fit_res <- fit_t_learner(
    df_median,
    treatment   = treatment,
    outcome     = outcome,
    covars      = confounders,
    learner     = learner
  )
  results_list[[learner]] <- fit_res
}
```

#### Visualize CATE vs Effect Modifiers

```{r}
for (learner in names(results_list)) {
  tau_vec <- results_list[[learner]]$tau
  for (mod in effect_modifiers) {
    plot_cate_vs_modifier(df_median, tau_vec, modifier = mod,
                          learner_name = learner)
  }
}

```

#### CATE vs Modifier Grid Analysis

```{r}
for (learner in names(results_list)) {

  cat("\n\n### Grid analysis â€“", learner, "\n\n")
  fits <- results_list[[learner]]
  fit1 <- fits$fit1[[1]]
  fit0 <- fits$fit0[[1]]

  for (mod in effect_modifiers) {

    grid_vals <- build_grid(df_median, mod)   # numeric or factor grid

    grid_df <- cate_grid_mean(
      fit0, fit1,
      df          = df_median,
      treatment   = treatment,
      modifier    = mod,
      grid_vals   = grid_vals
    )

    plot_cate_grid(grid_df, mod, learner)
  }
}
```
