---
title: "Propensity Scores & IPTW"
author: "Matan, Hillel & Yael"
date: "2025-06-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE}
# libraries, internal imports and constants
library(tidyverse)
source("utils/data_pipelines_utils.R")
source("utils/plot_utils.R")
source("utils/causal_utils.R")
```

```{r}
base_df <- read.csv("data/full_cohort_data.csv")

individual_properties <- c(
  "age", "gender_num", "weight_first", "bmi"
  )

sevirity_scores <- c(
  "sapsi_first", "sofa_first"
)

vital_signs <- c(
  "map_1st", "hr_1st", "temp_1st", "spo2_1st"
)

lab_results <- c(
  "wbc_first", "hgb_first", "platelet_first", "sodium_first", "potassium_first",
  "tco2_first", "chloride_first", "bun_first", "creatinine_first", "po2_first",
  "pco2_first"
)

first_day <- c("iv_day_1")

comorbidities <- c(
  "chf_flg", "afib_flg", "renal_flg", "liver_flg", "copd_flg",
  "cad_flg", "stroke_flg", "mal_flg", "resp_flg"
)

# stratify hour icu into bins for categorical variable
admission_properties <- c("service_unit", "day_icu_intime", "hour_icu_intime")

treatment <- c("aline_flg")
outcome <- c("day_28_flg")

confounders <- c(
  individual_properties, sevirity_scores, vital_signs, lab_results,
  first_day, comorbidities, admission_properties
)
```

## Missing Values EDA

```{r}
# Percentage of rows with at least one missing value
total_rows        <- nrow(base_df)
rows_with_missing <- sum(!complete.cases(base_df))
pct_rows_missing  <- rows_with_missing / total_rows * 100
cat(sprintf("Rows with ≥1 missing: %d / %d (%.2f%%)\n", 
            rows_with_missing, total_rows, pct_rows_missing))

# Percentage of missing values per column
col_pct_missing <- sapply(base_df, function(col) mean(is.na(col)) * 100)

missing_summary <- data.frame(
  variable    = names(col_pct_missing),
  pct_missing = col_pct_missing,
  row.names   = NULL
)

print(missing_summary %>% filter(pct_missing > 0))
```

```{r}
clean_df <- base_df %>%
  select(-bmi)

clean_confounders <- confounders[!confounders %in% "bmi"]
```

## Validating positivity across all confounders

```{r}
positivity_check_histograms(clean_df, treatment, clean_confounders)

```

Suspected positivity issues:\
po2_first - we deny this\
sofa_first - divide to the intervals: [0, 2,5) [2.5, 5) [5, 7.5) [7.5, 10} [10, \\inf)

## Dividing sofa_first

```{r}
final_base_df <- clean_df %>%
  mutate(sofa_first_cat = case_when(
    sofa_first < 2.5 ~ "0-2.5",
    sofa_first < 5   ~ "2.5-5",
    sofa_first < 7.5 ~ "5-7.5",
    sofa_first < 10  ~ "7.5-10",
    TRUE             ~ "10+"
  )) %>%
  select(-sofa_first)

# change sofa first to sofa_first_cat in the confounders on clean confounders
final_confounders <- clean_confounders[!clean_confounders %in% "sofa_first"]
final_confounders <- c(final_confounders, "sofa_first_cat")

positivity_check_histograms(final_base_df, treatment, final_confounders)
```

```{r}
# Final datasets based on the final_base_df

# Removed all NA values
df_no_na <- final_base_df %>%
  filter(complete.cases(final_base_df))

# mean imputation
df_mean_imputed <- impute_df(final_base_df, method = "mean")

# median imputation
df_median_imputed <- impute_df(final_base_df, method = "median")
```

## Estimate PS for 3 datasets

```{r}
# Estimate glm models for each ones without lasso
logreg_no_na_no_lasso <- model_ps_score(df_no_na, final_confounders, treatment, lasso = FALSE)
logreg_mean_imputed_no_lasso <- model_ps_score(df_mean_imputed, final_confounders, treatment, lasso = FALSE)
logreg_median_imputed_no_lasso <- model_ps_score(df_median_imputed, final_confounders, treatment, lasso = FALSE)

# Estimate glm models for each ones with lasso
logreg_no_na_lasso <- model_ps_score(df_no_na, final_confounders, treatment, lasso = TRUE)
logreg_mean_imputed_lasso <- model_ps_score(df_mean_imputed, final_confounders, treatment, lasso = TRUE)
logreg_median_imputed_lasso <- model_ps_score(df_median_imputed, final_confounders, treatment, lasso = TRUE)
```

```{r}
# extract propensity‐scores using extract_ps()
ps_no_na_no_lasso         <- extract_ps(logreg_no_na_no_lasso)
ps_mean_imputed_no_lasso  <- extract_ps(logreg_mean_imputed_no_lasso)
ps_median_imputed_no_lasso<- extract_ps(logreg_median_imputed_no_lasso)

ps_no_na_lasso            <- extract_ps(logreg_no_na_lasso,
                                        df_no_na,
                                        final_confounders,
                                        treatment)
ps_mean_imputed_lasso     <- extract_ps(logreg_mean_imputed_lasso,
                                        df_mean_imputed,
                                        final_confounders,
                                        treatment)
ps_median_imputed_lasso   <- extract_ps(logreg_median_imputed_lasso,
                                        df_median_imputed,
                                        final_confounders,
                                        treatment)

```

```{r}
# Plot propensity scores for each one of the 6 models

# No lasso models
plot_ps_hist(df_no_na, ps_no_na_no_lasso, treatment, plot_title="PS No NA | No Lasso")
plot_ps_hist(df_mean_imputed, ps_mean_imputed_no_lasso, treatment, plot_title="PS Mean Imputation | No Lasso")
plot_ps_hist(df_median_imputed, ps_median_imputed_no_lasso, treatment,
             plot_title="PS Median Imputation | No Lasso")

# With lasso models
plot_ps_hist(df_no_na, ps_no_na_lasso, treatment, plot_title="PS No NA | Lasso")
plot_ps_hist(df_mean_imputed, ps_mean_imputed_lasso, treatment, 
             plot_title="PS Mean Imputation | Lasso")
plot_ps_hist(df_median_imputed, ps_median_imputed_lasso, treatment,
             plot_title="PS Median Imputation | Lasso")
```

## Estimating ATE on 6 models

```{r}
# compute iptw weights for each of the 6 models

w_no_na <- iptw_weights(
  df            = df_no_na,
  ps_vec        = ps_no_na_no_lasso,
  treatment_col = treatment,
  stabilized    = TRUE,
  clip = TRUE
)

w_mean_imputed <- iptw_weights(
  df            = df_mean_imputed,
  ps_vec        = ps_mean_imputed_no_lasso,
  treatment_col = treatment,
  stabilized    = TRUE,
  clip = TRUE
)

w_median_imputed <- iptw_weights(
  df            = df_median_imputed,
  ps_vec        = ps_median_imputed_no_lasso,
  treatment_col = treatment,
  stabilized    = TRUE,
  clip = TRUE
)

w_no_na_lasso <- iptw_weights(
  df            = df_no_na,
  ps_vec        = ps_no_na_lasso,
  treatment_col = treatment,
  stabilized    = TRUE,
  clip = TRUE
)

w_mean_imputed_lasso <- iptw_weights(
  df            = df_mean_imputed,
  ps_vec        = ps_mean_imputed_lasso,
  treatment_col = treatment,
  stabilized    = TRUE,
  clip = TRUE
)


w_median_imputed_lasso <- iptw_weights(
  df            = df_median_imputed,
  ps_vec        = ps_median_imputed_lasso,
  treatment_col = treatment,
  stabilized    = TRUE,
  clip = TRUE
)


```

```{r}
# plot iptw weights histograms for all 6 models

plot_iptw_weights(
  df            = df_no_na,
  weights       = w_no_na,
  treatment_col = treatment,
  bins          = 30,
  plot_title    = "IPTW Weights (No NA, Stabilized)"
)

plot_iptw_weights(
  df            = df_mean_imputed,
  weights       = w_mean_imputed,
  treatment_col = treatment,
  bins          = 30,
  plot_title    = "IPTW Weights (Mean Imputation, Stabilized)"
)

plot_iptw_weights(
  df            = df_median_imputed,
  weights       = w_median_imputed,
  treatment_col = treatment,
  bins          = 30,
  plot_title    = "IPTW Weights (Median Imputation, Stabilized)"
)

plot_iptw_weights(
  df            = df_no_na,
  weights       = w_no_na_lasso,
  treatment_col = treatment,
  bins          = 30,
  plot_title    = "IPTW Weights (No NA, Lasso, Stabilized)"
)

plot_iptw_weights(
  df            = df_mean_imputed,
  weights       = w_mean_imputed_lasso,
  treatment_col = treatment,
  bins          = 30,
  plot_title    = "IPTW Weights (Mean Imputation, Lasso, Stabilized)"
)

plot_iptw_weights(
  df            = df_median_imputed,
  weights       = w_median_imputed_lasso,
  treatment_col = treatment,
  bins          = 30,
  plot_title    = "IPTW Weights (Median Imputation, Lasso, Stabilized)"
)
```

```{r}
# Estimate ATE For all models with clipping and stabilizing
ate_no_na <- iptw_ate(
  df            = df_no_na,
  outcome_col   = outcome,
  treatment_col = treatment,
  ps_vec        = ps_no_na_no_lasso,
  stabilized    = TRUE,
  clip          = TRUE
)

ate_mean_imputed <- iptw_ate(
  df            = df_mean_imputed,
  outcome_col   = outcome,
  treatment_col = treatment,
  ps_vec        = ps_mean_imputed_no_lasso,
  stabilized    = TRUE,
  clip          = TRUE
)

ate_median_imputed <- iptw_ate(
  df            = df_median_imputed,
  outcome_col   = outcome,
  treatment_col = treatment,
  ps_vec        = ps_median_imputed_no_lasso,
  stabilized    = TRUE,
  clip          = TRUE
)

ate_no_na_lasso <- iptw_ate(
  df            = df_no_na,
  outcome_col   = outcome,
  treatment_col = treatment,
  ps_vec        = ps_no_na_lasso,
  stabilized    = TRUE,
  clip          = TRUE
)

ate_mean_imputed_lasso <- iptw_ate(
  df            = df_mean_imputed,
  outcome_col   = outcome,
  treatment_col = treatment,
  ps_vec        = ps_mean_imputed_lasso,
  stabilized    = TRUE,
  clip          = TRUE
)

ate_median_imputed_lasso <- iptw_ate(
  df            = df_median_imputed,
  outcome_col   = outcome,
  treatment_col = treatment,
  ps_vec        = ps_median_imputed_lasso,
  stabilized    = TRUE,
  clip          = TRUE
)

# Print ATE results for each model
ate_results <- list(
  no_na                = ate_no_na,
  mean_imputed         = ate_mean_imputed,
  median_imputed       = ate_median_imputed,
  no_na_lasso          = ate_no_na_lasso,
  mean_imputed_lasso   = ate_mean_imputed_lasso,
  median_imputed_lasso = ate_median_imputed_lasso
)

for (model_name in names(ate_results)) {
  ate <- ate_results[[model_name]]
  cat(sprintf("Model: %s\n", model_name))
  cat(sprintf("Mean Treated: %.4f\n", ate$mean_treated))
  cat(sprintf("Mean Control: %.4f\n", ate$mean_control))
  cat(sprintf("ATE: %.4f\n", ate$ATE))
  cat("\n")
}
```
